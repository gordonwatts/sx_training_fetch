name: CI

on:
    push:
        branches:
            - main
            - "**" # All branches
    # Note: We explicitly do NOT trigger on pull_request to avoid duplicate runs
    # when pushing to a branch that has an open PR

jobs:
    lint:
        name: Lint with flake8
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python 3.13
              uses: actions/setup-python@v5
              with:
                  python-version: "3.13"

            - name: Install flake8
              run: |
                  python -m pip install --upgrade pip
                  pip install flake8

            - name: Run flake8
              run: flake8 calratio_training_data tests

    test:
        name: Test on Python ${{ matrix.python-version }}
        runs-on: ubuntu-latest
        needs: lint
        strategy:
            fail-fast: true
            matrix:
                python-version: ["3.11", "3.12", "3.13", "3.14"]

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}
                  allow-prereleases: true # Needed for Python 3.14 which may still be in pre-release

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -e ".[dev]"

            - name: Run tests (no-docker)
              run: |
                  pytest tests/ -v
